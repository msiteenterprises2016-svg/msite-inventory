<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MSITE Inventory (Modular Firebase)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#004b8d">
  <link rel="icon" href="msite.png" type="image/png">
  <style>
    :root{--msite-blue:#004b8d;--accent:#00bfa5;}
    body{font-family:Segoe UI,system-ui,Arial;margin:0;background:#f5faff;color:#222}
    .topbar{height:60px;background:linear-gradient(135deg,var(--msite-blue),#006bb3);color:#fff;display:flex;align-items:center;padding:0 20px;position:fixed;left:0;right:0;top:0;z-index:1000}
    .content{display:flex;margin-top:60px}
    .sidebar{width:220px;background:var(--msite-blue);color:#fff;padding:20px;box-sizing:border-box;min-height:calc(100vh - 60px)}
    .main{flex:1;padding:24px}
    .section{background:#fff;border-radius:12px;padding:20px;box-shadow:0 3px 8px rgba(0,0,0,0.06);margin-bottom:20px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #eee;text-align:center}
    th{background:var(--msite-blue);color:#fff}
    button{background:var(--msite-blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    input,select{padding:8px;border-radius:6px;border:1px solid #ccc}
    .status{position:fixed;right:16px;bottom:16px;padding:8px 12px;border-radius:999px;background:#eee;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .status.online{background:#dff7e0;color:#0a8a2c}
    .status.offline{background:#ffe6e6;color:#9b1c1c}
  </style>
</head>
<body>
  <header class="topbar"><div style="display:flex;align-items:center;gap:12px"><img src="msite.png" style="width:36px;height:36px;border-radius:6px"><strong>MSITE Inventory</strong></div></header>
  <div class="content">
    <aside class="sidebar">
      <h2 style="text-align:center">MSITE</h2>
      <a href="#" class="menu" data-sec="home">Home</a><br>
      <a href="#" class="menu" data-sec="stock">Stock Management</a><br>
      <a href="#" class="menu" data-sec="po">Purchase Order</a><br>
    </aside>
    <main class="main">
      <div id="home" class="section"><h1>Welcome</h1><p>This build uses Modular Firebase SDK and auto-syncs <strong>stock</strong>.</p></div>
      <div id="stock" class="section" style="display:none">
        <h1>Stock Management</h1>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <input id="name" placeholder="Item name">
          <input id="qty" type="number" placeholder="Qty" style="width:100px">
          <input id="unit" placeholder="Unit" style="width:100px">
          <input id="price" type="number" placeholder="Price" style="width:120px">
          <button id="addBtn">Add</button>
          <button id="syncBtn" style="background:var(--accent)">Sync Now</button>
        </div>
        <input id="search" placeholder="Search..." style="margin-bottom:8px;width:50%">
        <table><thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Action</th></tr></thead><tbody id="tbody"></tbody></table>
      </div>
      <div id="po" class="section" style="display:none"><h1>Purchase Order</h1><p>Works offline via localStorage.</p></div>
    </main>
  </div>

  <div id="status" class="status offline">Offline</div>

  <!-- Modular Firebase + app logic -->
  <script type="module">
    import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {{ getFirestore, collection, getDocs, addDoc, doc, setDoc, deleteDoc, onSnapshot }} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // user's firebase config will be inserted here
    const firebaseConfig = {"apiKey": "AIzaSyC36jo_Ol_PM3HDygz0SnisgAhLRomoejk", "authDomain": "msite-4db05.firebaseapp.com", "projectId": "msite-4db05", "storageBucket": "msite-4db05.firebasestorage.app", "messagingSenderId": "13176985563", "appId": "1:13176985563:web:2b7eb611ac70426035f9fe", "measurementId": "G-R5PWB2REMQ"};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCol = collection(db, 'stock');

    // local state
    let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
    function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }
    const tbody = document.getElementById('tbody');

    function render(){ 
      tbody.innerHTML = '';
      localStock.forEach((it, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td contenteditable="true" data-key="name" data-idx="${idx}">${escapeHtml(it.name)}</td>
                        <td contenteditable="true" data-key="qty" data-idx="${idx}">${it.qty}</td>
                        <td contenteditable="true" data-key="unit" data-idx="${idx}">${escapeHtml(it.unit||'')}</td>
                        <td contenteditable="true" data-key="price" data-idx="${idx}">${Number(it.price||0).toFixed(2)}</td>
                        <td><button class="del" data-idx="${idx}">Delete</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // add item locally then try upload
    document.getElementById('addBtn').addEventListener('click', async ()=>{
      const name = document.getElementById('name').value.trim();
      const qty = Number(document.getElementById('qty').value) || 0;
      const unit = document.getElementById('unit').value.trim();
      const price = Number(document.getElementById('price').value) || 0;
      if(!name) return alert('Enter name');
      const item = { name, qty, unit, price };
      localStock.push(item); saveLocal(); render();
      // attempt to add to Firestore
      try{ const d = await addDoc(stockCol, item); item.id = d.id; saveLocal(); render(); }catch(e){ console.warn('offline, queued', e); }
      // clear inputs
      document.getElementById('name').value=''; document.getElementById('qty').value=''; document.getElementById('unit').value=''; document.getElementById('price').value='';
    });

    // Sync now button - attempt to upload local items without id
    document.getElementById('syncBtn').addEventListener('click', async ()=>{ await syncPending(); alert('Sync attempted'); });

    async function syncPending(){
      if(!navigator.onLine) return alert('Offline');
      // upload local items missing id
      for(const item of localStock){
        if(!item.id){ 
          try{
            const d = await addDoc(stockCol, { name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = d.id; saveLocal();
          }catch(e){ console.warn('sync failed', e); }
        } else {
          // set/update
          try{ await setDoc(doc(db, 'stock', item.id), { name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
    }

    // live listener
    try{
      onSnapshot(stockCol, snapshot => {
        const cloud = [];
        snapshot.forEach(d=> cloud.push(Object.assign({ id:d.id }, d.data())));
        if(cloud.length>0){
          // merge: cloud overrides, keep any local-only appended
          const localOnly = localStock.filter(ls => !cloud.some(ci => ci.name===ls.name && ci.qty===ls.qty));
          localStock = cloud.concat(localOnly);
          saveLocal(); render();
        }
      });
    }catch(e){ console.warn('listener failed', e); }

    // process pending on online
    window.addEventListener('online', ()=>{ document.getElementById('status').className='status online'; document.getElementById('status').textContent='Online'; syncPending(); });
    window.addEventListener('offline', ()=>{ document.getElementById('status').className='status offline'; document.getElementById('status').textContent='Offline'; });

    // initial UI and navigation
    document.querySelectorAll('.menu').forEach(a=> a.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelectorAll('.section').forEach(s=>s.style.display='none'); document.getElementById(a.dataset.sec).style.display='block'; }));
    document.getElementById('status').className = navigator.onLine ? 'status online' : 'status offline';
    document.getElementById('status').textContent = navigator.onLine ? 'Online' : 'Offline';
    render();

    // simple deletion & inline edit handling (event delegation)
    tbody.addEventListener('click', async (e)=>{
      if(e.target.classList.contains('del')){
        const idx = Number(e.target.dataset.idx);
        const item = localStock[idx];
        if(item && item.id){
          try{ await deleteDoc(doc(db, 'stock', item.id)); }catch(err){ console.warn(err); }
        }
        localStock.splice(idx,1); saveLocal(); render();
      }
    });

    tbody.addEventListener('blur', async (e)=>{
      const td = e.target;
      if(td && td.hasAttribute('data-key')){
        const key = td.getAttribute('data-key');
        const idx = Number(td.getAttribute('data-idx'));
        let val = td.textContent.trim();
        if(key==='qty' || key==='price') val = Number(val) || 0;
        localStock[idx][key] = val;
        saveLocal();
        const it = localStock[idx];
        if(it.id){
          try{ await setDoc(doc(db,'stock', it.id), { name:it.name, qty:it.qty, unit:it.unit||'', price:it.price||0 }); }catch(e){ console.warn(e); }
        }
      }
    }, true);

  </script>

  <!-- service worker registration -->
  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')).catch(()=>{});
    }
  </script>
</body>
</html>
