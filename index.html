<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#004b8d">
<link rel="icon" href="msite.png" type="image/png">

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MSITE Inventory System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
<style>
/* ===== Modern Font & Button Styles ===== */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');

body {
  font-family: 'Poppins', sans-serif;
  color: #2c3e50;
}

/* Global button style */
button {
  background: linear-gradient(135deg, var(--msite-blue-2), var(--accent));
  color: #fff;
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  letter-spacing: 0.3px;
  cursor: pointer;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  transition: all 0.25s ease;
}

button:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, var(--msite-blue), var(--accent));
  box-shadow: 0 5px 12px rgba(0,0,0,0.15);
}

button:active {
  transform: scale(0.97);
}

/* Sidebar links */
.sidebar a {
  font-weight: 500;
  letter-spacing: 0.5px;
  transition: background 0.3s, transform 0.2s;
}

.sidebar a:hover, .sidebar a.active {
  background: var(--msite-blue-2);
  transform: translateX(3px);
}

/* Headings */
h1, h2, h3 {
  font-weight: 600;
  letter-spacing: 0.5px;
}

/* Inputs */
input, select {
  border: 1px solid #ccd9e4;
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.25s;
}

input:focus, select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(42,157,143,0.15);
}

    /* ========== MSITE THEME ========== */
  :root {
  --msite-blue: #004b8d;
  --msite-blue-2: #006bb3;
  --accent: #00bfa5;
  --danger: #e63946;
}

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #f5faff;
      color: #333;
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    .content { flex: 1; display: flex; min-height: 0; }
    .sidebar {
      width: 220px;
      background-color: var(--msite-blue);
      color: #fff;
      padding: 20px 0;
      display:flex;flex-direction:column;align-items:center;
    }
    .sidebar img { width:100px; margin-bottom:10px; }
    .sidebar h2 { margin-bottom:18px; letter-spacing:1px; }
    .sidebar a {
      padding:12px 20px; color:#fff; text-decoration:none; display:block; width:100%; text-align:center;
      transition:background 0.2s;
    }
    .sidebar a:hover, .sidebar a.active { background:var(--msite-blue-2); }

    .main { flex:1; display:flex; flex-direction:column; overflow-y:auto; padding:20px; box-sizing:border-box; }
    .section { display:none; padding:0 0 40px 0; }
    .section.active { display:block; animation:fadeIn .25s ease-in; }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    h1 { color:var(--msite-blue); border-bottom:2px solid var(--msite-blue-2); padding-bottom:8px; margin-bottom:16px; }

    input, select, button { padding:8px; margin:5px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    button{ background:var(--msite-blue-2); color:#fff; border:none; cursor:pointer; }
    button:hover{ background:var(--msite-blue); }

    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th, td{ border:1px solid #ddd; padding:8px; text-align:center; }
    th{ background:var(--msite-blue); color:#fff; }
    td.editing{ background:#fff8c4; } /* light yellow while editing */
    .action-btn{ padding:5px 10px; font-size:12px; margin:2px; border-radius:4px; color:#fff; cursor:pointer; }
    .delete-btn{ background:var(--danger); }
    .view-btn{ background:var(--accent); }

    .summary{ margin-top:20px; background:#e8f0ff; padding:10px; border-radius:6px; }
    .grand-total{ margin-top:10px; text-align:right; font-weight:bold; color:var(--msite-blue); }

    .frontpage{ display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:80px 20px; background:#e8f0ff; min-height:300px; }
    .frontpage h1{ font-size:2.2rem; color:var(--msite-blue); margin:0 0 10px 0; }
    .frontpage p{ max-width:700px; color:#333; line-height:1.6; }

    footer{ text-align:center; padding:12px; font-size:0.95rem; color:#fff; background:var(--msite-blue); width:100%; }

    /* In-app receipt preview (compact box) */
    #receipt, #cashout-receipt {
      display:none;
      background:#fff;
      padding:10px;
      border:1px solid #ccc;
      margin:12px auto;
      width:320px;
      font-size:12px;
      font-family: "Segoe UI", sans-serif;
      box-sizing:border-box;
    }
    #receipt .receipt-inner, #cashout-receipt .receipt-inner {
      background: #fff;
      padding: 6px;
      border-radius: 4px;
    }

    @media (max-width:700px){
      .sidebar{ display:none }
      #receipt, #cashout-receipt{ width:100%; box-sizing:border-box }
    }

    /* Receipt preview modal (in-page) */
    .modal-backdrop {
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,0.6);
      align-items:center; justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.show { display:flex; }
    .modal-box {
      background:#fff; padding:12px; border-radius:8px; width:90%; max-width:720px; box-sizing:border-box;
    }
    .modal-actions { text-align:center; margin-top:10px; }
    .modal-actions button { margin:0 6px; }
/* Sidebar icons */
.sidebar a {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 10px;
  font-size: 0.95rem;
  padding: 12px 20px;
}

.sidebar a i {
  font-size: 1.1rem;
  transition: transform 0.3s, color 0.3s;
}

.sidebar a:hover i {
  transform: rotate(8deg) scale(1.1);
  color: #ffe066;
}

/* Collapsed mode */
.sidebar.collapsed a span {
  display: none;
}

.sidebar.collapsed a {
  justify-content: center;
}

.sidebar.collapsed a i {
  font-size: 1.3rem;
}

/* Sidebar hover animation */
.sidebar a:hover {
  background: var(--msite-blue-2);
  transform: translateX(3px);
  border-radius: 6px;
}

  </style>
<!-- iOS PWA Compatibility -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="MSITE">
<link rel="apple-touch-icon" href="msite.png">

</head>
<body>
<header class="topbar">
  <div class="topbar-left">
    <img src="msite.png" alt="Logo" class="logo-small">
    <h1 class="app-title">MSITE Inventory System</h1>
  </div>
</header>

  <div class="content">
    <div class="sidebar">
  
  <img src="msite.png" alt="MSITE Logo">
  <h2>MSITE</h2>

  <a href="#" class="menu-link active" data-section="home-section">
    <i class="fas fa-home"></i> <span>Home</span>
  </a>
  <a href="#" class="menu-link" data-section="stock-section">
    <i class="fas fa-boxes-stacked"></i> <span>Stock Management</span>
  </a>
  <a href="#" class="menu-link" data-section="purchase-section">
    <i class="fas fa-file-invoice-dollar"></i> <span>Purchase Order</span>
  </a>
  <a href="#" class="menu-link" data-section="po-list-section">
    <i class="fas fa-list"></i> <span>PO List</span>
  </a>
  <a href="#" class="menu-link" data-section="cashout-section">
    <i class="fas fa-cash-register"></i> <span>Cashout</span>
  </a>
  <a href="#" class="menu-link" data-section="sales-section">
    <i class="fas fa-chart-line"></i> <span>Sales History</span>
  </a>
  <a href="#" class="menu-link" data-section="buy-section">
    <i class="fas fa-cart-plus"></i> <span>Items to Buy</span>
  </a>
</div>
<button id="toggleSidebar">=</button>


    <div class="main">
      <!-- Home -->
      <div id="home-section" class="section active">
        <div class="frontpage">
          <h1>Welcome to MSITE Enterprises</h1>
          <p>MSITE is a trusted enterprise specializing in school materials, durable furniture, and construction essentials. Providing affordable, top-grade products for schools and businesses since 2016.</p>
        </div>
      </div>

      <!-- Stock Management -->
<div id="stock-section" class="section">
  <h1>Stock Management</h1>
  <div class="form-row">
    <input id="stock-name" placeholder="Item Name">
    <input id="stock-qty" type="number" placeholder="Quantity">
    <input id="stock-unit" placeholder="Unit">
    <input id="stock-price" type="number" placeholder="Price">
    <button onclick="addStock()">Add Item</button>
  </div>

  <div class="form-row">
    <input id="stock-search" placeholder="Search item...">
  </div>

  <table id="stockTable">
    <thead>
      <tr>
        <th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="stockTableBody"></tbody>
  </table>
<div style="margin-top: 20px; text-align: center;">
  <button onclick="printStockTable()" style="
    background-color: #0a3d62;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 18px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;">
   Print Stock List
  </button>
</div>

</div>


<!-- Items to Buy Section -->
<div id="buy-section" class="section buy-card">
  <h1>Items to Buy</h1>
  
  <!-- Input Form -->
  <div class="buy-form">
    <input type="text" id="itemName" placeholder="Item Name">
    <input type="text" id="itemUnit" placeholder="Unit (pcs, kg...)">
    <input type="number" id="itemQty" placeholder="Qty">
    <input type="number" id="itemPrice" placeholder="Price">
    <button onclick="addBuyItem()">Add</button>
  </div>

  <!-- Search Bar -->
  <div class="buy-search">
    <input id="buy-search" placeholder="Search item...">
  </div>

  <!-- Items Table -->
  <div class="buy-table-wrapper">
    <table id="buyTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Unit</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="buyTableBody"></tbody>
    </table>
  </div>

  <!-- Action Buttons -->
  <div class="buy-actions">
    <button onclick="confirmBuyList()">Confirm Order</button>
    <button onclick="printBuyList()">Print Buy List</button>
  </div>
</div>

<style>
/* Card Layout */
.buy-card {
  background-color: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  max-width: 900px;
  margin: 20px auto;
  font-family: Arial, sans-serif;
}

/* Section Header */
.buy-card h1 {
  margin-bottom: 16px;
  font-size: 1.5rem;
  color: #1e6091;
}

/* Input Form */
.buy-form {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 12px;
}

.buy-form input {
  flex: 1;
  min-width: 100px;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.buy-form button {
  padding: 8px 16px;
  border: none;
  background-color: #1e6091;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

.buy-form button:hover {
  background-color: #0a3d62;
}

/* Search Bar */
.buy-search {
  margin-bottom: 12px;
  text-align: right;
}

.buy-search input {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 220px;
}

/* Table  MSITE Themed */
.buy-table-wrapper {
  overflow-x: auto;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#buyTable {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
}

#buyTable th, #buyTable td {
  padding: 10px;
  text-align: center;
  border: 1px solid #ddd;
}

#buyTable th {
  background-color: var(--msite-blue);
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

#buyTable tr:nth-child(even) {
  background-color: #f9fbff;
}

#buyTable tr:hover {
  background-color: #e8f0ff;
  transition: background 0.2s;
}


/* Action Buttons */
.buy-actions {
  margin-top: 12px;
  display: flex;
  gap: 10px;
}

.buy-actions button {
  padding: 8px 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background-color: #0a3d62;
  color: white;
  transition: background 0.3s;
}

.buy-actions button:hover {
  background-color: #1e6091;
}
/* ======== UI UPGRADE: Layout, Tables & Collapsible Sidebar ======== */

/* Global layout polish */
.main {
  flex: 1;
  background: #f8fbff;
  padding: 24px;
  border-radius: 16px 0 0 0;
  overflow-y: auto;
}

/* Card containers for sections */
.section {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
  margin-bottom: 30px;
}

/* Headings */
.section h1 {
  font-size: 1.5rem;
  margin-bottom: 16px;
  color: var(--msite-blue);
  border-bottom: 2px solid var(--msite-blue-2);
  padding-bottom: 8px;
}

/* Table Styling */
table {
  width: 100%;
  border-collapse: collapse;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 1px 6px rgba(0,0,0,0.05);
}

th, td {
  padding: 10px 12px;
  text-align: center;
}

th {
  background: var(--msite-blue);
  color: white;
  font-weight: 500;
  letter-spacing: 0.4px;
}

tr:nth-child(even) {
  background: #f7faff;
}

tr:hover {
  background: #eaf3ff;
  transition: background 0.25s;
}

/* Sidebar enhancements */
.sidebar {
  position: relative;
  transition: all 0.3s ease;
  width: 240px;
}

.sidebar.collapsed {
  width: 70px;
}

.sidebar.collapsed h2,
.sidebar.collapsed img {
  display: none;
}

.sidebar.collapsed a {
  text-align: center;
  font-size: 0.85rem;
  padding: 12px 0;
}

/* Toggle button for sidebar */
#toggleSidebar {
  position: absolute;
  top: 10px;
  right: -15px;
  background: var(--accent);
  color: white;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  border: none;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  line-height: 0;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  transition: background 0.3s;
}

#toggleSidebar:hover {
  background: var(--msite-blue-2);
}

/* Adjust layout when sidebar collapses */
.content {
  display: flex;
  transition: all 0.3s ease;
}

.content.sidebar-collapsed .main {
  margin-left: 70px;
}

/* Make tables and forms responsive */
@media (max-width: 700px) {
  .section {
    padding: 16px;
  }
  table, thead, tbody, th, td, tr {
    display: block;
  }
  th {
    display: none;
  }
  td {
    text-align: right;
    position: relative;
    padding-left: 50%;
  }
  td::before {
    content: attr(data-label);
    position: absolute;
    left: 10px;
    text-align: left;
    font-weight: 600;
  }
}
/* ====== TOPBAR & LAYOUT ENHANCEMENTS ====== */
.topbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(135deg, var(--msite-blue), var(--msite-blue-2));
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 1000;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.topbar .app-title {
  font-size: 1.2rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.logo-small {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  object-fit: contain;
}

/* Sidebar Adjustments */
.sidebar {
  margin-top: 60px;
  height: calc(100vh - 60px);
  transition: width 0.3s ease, background 0.3s ease;
  box-shadow: 2px 0 10px rgba(0,0,0,0.05);
}

/* Smooth slide animation for collapse */
.sidebar.collapsed {
  width: 70px;
  overflow: hidden;
}

/* Content adjusts when sidebar collapses */
.content {
  margin-top: 60px;
  transition: margin-left 0.3s ease;
}

.content.sidebar-collapsed .main {
  margin-left: 70px;
}

/* Main Section Design */
.main {
  background: #f5f9ff;
  padding: 32px;
  border-radius: 16px;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
}

/* Section Cards */
.section {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 32px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.06);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.section:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

/* Buttons refined */
button {
  border-radius: 8px;
  font-weight: 500;
  padding: 10px 18px;
  transition: background 0.25s, transform 0.25s;
}

button:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, var(--msite-blue-2), var(--accent));
}

/* Sidebar toggle button inside topbar */
.sidebar-toggle {
  background: transparent;
  color: #fff;
  border: none;
  font-size: 1.4rem;
  cursor: pointer;
  transition: transform 0.2s;
}

.sidebar-toggle:hover {
  transform: scale(1.1);
}

/* Responsive Adjustments */
@media (max-width: 700px) {
  .topbar {
    height: 56px;
    padding: 0 12px;
  }
  .app-title {
    font-size: 1rem;
  }
  .main {
    padding: 16px;
  }
}
/* === Sidebar Toggle Button Styling === */
.sidebar #toggleSidebar {
  position: absolute;
  top: 16px;
  right: -15px;
  background: var(--accent);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 3px 8px rgba(0,0,0,0.25);
  z-index: 10;
}

.sidebar #toggleSidebar:hover {
  background: var(--msite-blue-2);
  transform: scale(1.05);
}

/* When sidebar is collapsed, adjust button placement */
.sidebar.collapsed #toggleSidebar {
  right: -20px;
}
/* ==== Floating Sidebar Toggle Button Upgrade ==== */
#toggleSidebar {
  position: fixed;
  top: 80px;
  left: 220px; /* where the sidebar ends */
  background: linear-gradient(135deg, var(--accent), var(--msite-blue-2));
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  z-index: 1200;
  transition: all 0.3s ease;
}

#toggleSidebar:hover {
  background: linear-gradient(135deg, var(--msite-blue-2), var(--accent));
  transform: scale(1.1);
}

/* When sidebar collapses, move the toggle closer */
.sidebar.collapsed ~ #toggleSidebar {
  left: 70px;
}



</style>


      <!-- Purchase Order -->
      <div id="purchase-section" class="section">
        <h1>Purchase Order</h1>
        <input list="po-item-list" id="poItem" class="item-select" placeholder="Select Item">
        <datalist id="po-item-list"></datalist>
        <input type="number" id="poQty" placeholder="Quantity"> <input type="text" id="po-school" placeholder="School Name">
        <button onclick="addToCurrentPO()">Add to Order</button>  <button onclick="submitPO()">Submit Order</button>

        <div style="margin-top:8px;">
          <label for="receipt-size-po">Paper Size:</label>
          <select id="receipt-size-po">
            <option value="58mm">Thermal (58mm)</option>
            <option value="80mm">Thermal (80mm)</option>
            <option value="A5">A5</option>
            <option value="A4">A4</option>
          </select>
          <button onclick="previewPOReceipt()">Preview & Print Receipt</button>
        </div>

        <table id="poTable">
          <thead>
            <tr><th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th><th>Action</th></tr>
          </thead>
          <tbody id="poTableBody"></tbody>
        </table>

        <div class="grand-total">PO Total: <span id="po-total">0.00</span></div>
        <div id="receipt" aria-hidden="true"></div>
      </div>

      <!-- PO List -->
      <div id="po-list-section" class="section">
        <h1>Purchase Order List</h1>
        <table id="po-list-table">
          <thead><tr><th>Date</th><th>School</th><th>Total</th><th>Action</th></tr></thead>
          <tbody id="po-list-body"></tbody>
        </table>
      </div>

      <!-- Cashout -->
      <div id="cashout-section" class="section">
        <h1>Cashout</h1>
        <input list="item-list" id="cashout-item" class="item-select" placeholder="Select Item">
        <datalist id="item-list"></datalist>
        <input type="number" id="cashout-qty" placeholder="Quantity">
        <button onclick="addToCashout()">Add to Sales</button>
        <button onclick="finalizeCashout()">Finalize & Save</button>

        <div style="margin-top:8px;">
          <label for="receipt-size-cash">Paper Size:</label>
          <select id="receipt-size-cash">
            <option value="58mm">Thermal (58mm)</option>
            <option value="80mm">Thermal (80mm)</option>
            <option value="A5">A5</option>
            <option value="A4">A4</option>
          </select>
          <button onclick="previewCashoutReceipt()">Preview & Print Receipt</button>
        </div>

        <div class="summary">
          <table id="salesTable">
            <thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th><th>Action</th></tr></thead>
            <tbody id="salesTableBody"></tbody>
          </table>
          <div class="grand-total">Grand Total: <span id="salesTotal">0.00</span></div>
        </div>

        <div id="cashout-receipt" aria-hidden="true"></div>
      </div>

      <!-- Sales History -->
      <div id="sales-section" class="section">
        <h1>Sales History</h1>
        <button onclick="clearSalesHistory()">Clear History</button>
        <table id="history-table">
          <thead><tr><th>Date</th><th>Item</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th><th>School</th></tr></thead>
          <tbody id="history-table-body"></tbody>
        </table>
      </div>

    </div>
  </div>

  <footer><strong>Mr. Michael Martinez | Since 2016 | Registered to PhilGEPS</strong></footer>

  <!-- In-page preview modal (fallback) -->
  <div id="preview-modal" class="modal-backdrop">
    <div class="modal-box">
      <div id="preview-content"></div>
      <div class="modal-actions">
        <button onclick="openPrintWindowFromModal()">Open Print Window</button>
        <button onclick="closeModalPreview()">Close Preview</button>
      </div>
    </div>
  </div>

  <script>	
    /* ===========================
       Persistent data stores
       =========================== */
    let stockData = JSON.parse(localStorage.getItem('stockData')) || [];
    let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
    let poList = JSON.parse(localStorage.getItem('poList')) || [];
    let currentPO = [];
    let cashoutBuffer = JSON.parse(localStorage.getItem('cashoutBuffer')) || [];

    // State to track last preview type for auto-clear after print
    let lastPreviewType = null; // 'cash' | 'po' | null
    let lastPreviewPayload = null;

    function saveData(){
      localStorage.setItem('stockData', JSON.stringify(stockData));
      localStorage.setItem('salesData', JSON.stringify(salesData));
      localStorage.setItem('poList', JSON.stringify(poList));
      localStorage.setItem('cashoutBuffer', JSON.stringify(cashoutBuffer));
    }

    function escapeHtml(str){
      if (str === null || str === undefined) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
let buyList = JSON.parse(localStorage.getItem('buyList')) || [];

function saveBuyList() {
  localStorage.setItem('buyList', JSON.stringify(buyList));
}

function renderBuyList() {
  const tbody = document.getElementById('buyTableBody');
  tbody.innerHTML = '';
  buyList.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.name}</td>
      <td>${item.unit}</td> <!-- render unit -->
      <td>${item.qty}</td>
      <td>${item.price.toFixed(2)}</td>
      <td><button onclick="removeBuyItem(${idx})">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function removeBuyItem(index) {
  if (!confirm('Are you sure you want to delete this item?')) return;
  buyList.splice(index, 1);   // remove from array
  saveBuyList();              // update localStorage
  renderBuyList();            // re-render the table
}
	






// Add item
function addBuyItem() {
  const name = document.getElementById('itemName').value;
  const unit = document.getElementById('itemUnit').value; // <-- unit captured
  const qty = Number(document.getElementById('itemQty').value);
  const price = Number(document.getElementById('itemPrice').value);

  if(!name || !unit || !qty || !price) return alert('Please fill all fields.');

  buyList.push({ name, unit, qty, price });
  saveBuyList();
  renderBuyList();
}


// Search filter
document.getElementById('buy-search').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  const tbody = document.getElementById('buyTableBody');
  Array.from(tbody.rows).forEach(row => {
    const itemName = row.cells[0].textContent.toLowerCase();
    row.style.display = itemName.includes(query) ? '' : 'none';
  });
});

// Initialize
renderBuyList();

function printBuyList() {
  if (buyList.length === 0) return alert('No items to print!');

  let rows = '';
  let grandTotal = 0;

  buyList.forEach(item => {
    const total = item.qty * item.price;
    grandTotal += total;
    rows += `
      <tr>
        <td style="padding:6px 4px;border-bottom:1px dashed #ccc;">${escapeHtml(item.name)}</td>
        <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:center;">${escapeHtml(item.unit || '')}</td>
        <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:center;">${item.qty}</td>
        <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:right;">${Number(item.price).toFixed(2)}</td>
        <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:right;">${total.toFixed(2)}</td>
      </tr>
    `;
  });

  const html = `
    <div style="font-family:'Segoe UI',sans-serif; width:320px; margin:0 auto;">
      <div style="text-align:center; margin-bottom:6px;">
        <h2 style="margin:0; color:var(--msite-blue);">MSITE Enterprises</h2>
       

      </div>

      <div style="margin-top:8px;font-weight:bold;text-align:center;">ITEMS TO BUY</div>
      <hr style="border:none;border-top:1px dashed #333;margin:8px 0;">

      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left;padding:6px 4px;">Item</th>
            <th style="text-align:center;padding:6px 4px;">Unit</th>
            <th style="text-align:center;padding:6px 4px;">Qty</th>
            <th style="text-align:right;padding:6px 4px;">Price</th>
            <th style="text-align:right;padding:6px 4px;">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>

      <div style="margin-top:8px;text-align:right;font-weight:bold;">
        Grand Total: ${grandTotal.toFixed(2)}
      </div>

      <hr style="border:none;border-top:1px dashed #333;margin:8px 0;">
  
    </div>
  `;

  const w = window.open('', '', 'height=600,width=800');
  w.document.write('<html><head><title>Buy List</title></head><body>');
  w.document.write(html);
  w.document.write('
<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body></html>');
  w.document.close();
  w.focus();
  w.print();
  w.close();
}




    /* ===========================
       STOCK - render/manage
       =========================== */
    function renderStock(){
      const tbody = document.getElementById('stockTableBody');
      const datalist = document.getElementById('item-list');
      const poListData = document.getElementById('po-item-list');
      tbody.innerHTML = ''; if(datalist) datalist.innerHTML = ''; if(poListData) poListData.innerHTML = '';

      stockData.forEach((item, idx) => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        tdName.textContent = item.name;
        tdName.contentEditable = true;
        tdName.addEventListener('blur', () => {
          const v = tdName.textContent.trim();
          if(!v){ renderStock(); return; }
          stockData[idx].name = v;
          saveData();
          updateItemLists();
        });
        tr.appendChild(tdName);

        const tdQty = document.createElement('td');
        tdQty.textContent = item.qty;
        tdQty.contentEditable = true;
        tdQty.addEventListener('blur', ()=> {
          const n = parseFloat(tdQty.textContent);
          if(isNaN(n)){ renderStock(); return; }
          stockData[idx].qty = n;
          saveData();
        });
        tr.appendChild(tdQty);

        const tdUnit = document.createElement('td');
        tdUnit.textContent = item.unit || '';
        tdUnit.contentEditable = true;
        tdUnit.addEventListener('blur', ()=> {
          stockData[idx].unit = tdUnit.textContent.trim();
          saveData();
          updateItemLists();
        });
        tr.appendChild(tdUnit);

        const tdPrice = document.createElement('td');
        tdPrice.textContent = item.price;
        tdPrice.contentEditable = true;
        tdPrice.addEventListener('blur', ()=> {
          const n = parseFloat(tdPrice.textContent);
          if(isNaN(n)){ renderStock(); return; }
          stockData[idx].price = n;
          saveData();
        });
        tr.appendChild(tdPrice);

        const tdAction = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.className = 'action-btn delete-btn';
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => { if(confirm('Delete this item?')) { stockData.splice(idx,1); saveData(); renderStock(); updateItemLists(); } };
        tdAction.appendChild(delBtn);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);

        if (datalist) datalist.insertAdjacentHTML("beforeend", `<option value="${escapeHtml(item.name)}">`);
        if (poListData) poListData.insertAdjacentHTML("beforeend", `<option value="${escapeHtml(item.name)}">`);
      });
      updateItemLists();
    }

// Real-time search in Stock Management
document.getElementById('stock-search').addEventListener('input', function() {
  const query = this.value.toLowerCase();
  const tbody = document.getElementById('stockTableBody');
  Array.from(tbody.rows).forEach(row => {
    const itemName = row.cells[0].textContent.toLowerCase();
    if(itemName.includes(query)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }	
  });
});

let confirmedOrders = JSON.parse(localStorage.getItem('confirmedOrders')) || [];

function confirmBuyList() {
  if (buyList.length === 0) return alert('No items to confirm.');

  // Calculate grand total
  let grandTotal = buyList.reduce((sum, item) => sum + item.qty * item.price, 0);

  // Create order object
  const order = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    items: JSON.parse(JSON.stringify(buyList)),
    total: grandTotal
  };

  // Save to confirmed orders
  confirmedOrders.push(order);
  localStorage.setItem('confirmedOrders', JSON.stringify(confirmedOrders));

  // Clear current buy list
  buyList = [];
  saveBuyList();
  renderBuyList();

  alert(`Order confirmed! Total: ${grandTotal.toFixed(2)}`);
}



    function addStock(){
      const name = document.getElementById("stock-name").value.trim();
      const qty = parseFloat(document.getElementById("stock-qty").value);
      const unit = document.getElementById("stock-unit").value.trim();
      const price = parseFloat(document.getElementById("stock-price").value);

      if (!name || isNaN(qty) || qty <= 0 || isNaN(price) ) {
        return alert("Please enter valid name, quantity and price.");
      }

      const existing = stockData.find(s => s.name.toLowerCase() === name.toLowerCase());
      if (existing) {
        existing.qty += qty;
        if (unit) existing.unit = unit;
        existing.price = price;
      } else {
        stockData.push({ name, qty, unit: unit || '', price });
      }
      saveData();
      renderStock();
      updateItemLists();
      document.getElementById("stock-name").value = "";
      document.getElementById("stock-qty").value = "";
      document.getElementById("stock-unit").value = "";
      document.getElementById("stock-price").value = "";
    }

    function updateItemLists(){
      const selects = document.querySelectorAll('.item-select');
      selects.forEach(sel=>{
        const cur = sel.value;
        sel.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.text = '';
        sel.appendChild(placeholder);
        stockData.forEach(item=>{
          const opt = document.createElement('option');
          opt.value = item.name;
          opt.text = `${item.name} (${item.unit || ''})`;
          sel.appendChild(opt);
        });
        sel.value = cur;
      });
    }

    /* ===========================
       PURCHASE ORDER (currentPO)
       =========================== */
    function addToCurrentPO(){
      const name = document.getElementById('poItem').value.trim();
      const qty = parseFloat(document.getElementById('poQty').value);
      if (!name || isNaN(qty) || qty <= 0) return alert('Enter valid item and quantity');
      const stock = stockData.find(s => s.name.toLowerCase() === name.toLowerCase());
      if (!stock) return alert('Item not found in stock');
      const price = Number(stock.price) || 0;
      currentPO.push({ name: stock.name, qty, unit: stock.unit || '', price, total: qty * price });
      renderPO();
      document.getElementById('poItem').value = '';
      document.getElementById('poQty').value = '';
    }

    function renderPO(){
      const tbody = document.getElementById('poTableBody');
      tbody.innerHTML = '';
      let sum = 0;
      currentPO.forEach((row, idx)=>{
        row.total = Number(row.qty) * Number(row.price);
        sum += row.total;
        const tr = document.createElement('tr');

        const tdName = document.createElement('td'); tdName.textContent = row.name; tr.appendChild(tdName);
        const tdQty = document.createElement('td'); tdQty.textContent = row.qty; tdQty.contentEditable = true; tr.appendChild(tdQty);
        const tdUnit = document.createElement('td'); tdUnit.textContent = row.unit || ''; tdUnit.contentEditable = true; tr.appendChild(tdUnit);
        const tdPrice = document.createElement('td'); tdPrice.textContent = Number(row.price).toFixed(2); tdPrice.contentEditable = true; tr.appendChild(tdPrice);
        const tdTotal = document.createElement('td'); tdTotal.textContent = row.total.toFixed(2); tr.appendChild(tdTotal);

        const tdAction = document.createElement('td');
        const del = document.createElement('button'); del.className='action-btn delete-btn'; del.textContent='Delete';
        del.onclick = ()=> { currentPO.splice(idx,1); renderPO(); };
        tdAction.appendChild(del);
        tr.appendChild(tdAction);

        // inline editable events
        tdQty.addEventListener('blur', ()=>{ const v = parseFloat(tdQty.textContent); if(isNaN(v) || v<=0){ renderPO(); return; } currentPO[idx].qty = v; currentPO[idx].total = currentPO[idx].qty * currentPO[idx].price; saveData(); renderPO(); });
        tdUnit.addEventListener('blur', ()=>{ currentPO[idx].unit = tdUnit.textContent.trim(); saveData(); renderPO(); });
        tdPrice.addEventListener('blur', ()=>{ const v = parseFloat(tdPrice.textContent); if(isNaN(v) || v<0){ renderPO(); return; } currentPO[idx].price = v; currentPO[idx].total = currentPO[idx].qty * currentPO[idx].price; saveData(); renderPO(); });

        tbody.appendChild(tr);
      });
      document.getElementById('po-total').textContent = sum.toFixed(2);
    }

    function submitPO(){
      const school = document.getElementById('po-school').value.trim();
      if (!school) return alert('Enter school name');
      if (currentPO.length===0) return alert('No items in order');

      // check stock
      for(const it of currentPO){
        const s = stockData.find(x=>x.name===it.name);
        if(!s) return alert('Item not in stock: ' + it.name);
        if(s.qty < it.qty) return alert('Not enough stock for: ' + it.name);
      }

      let total = 0;
      currentPO.forEach(i=>{
        const s = stockData.find(x=>x.name===i.name);
        s.qty -= i.qty;
        total += i.total;
        salesData.push({
          date: new Date().toLocaleString(),
          name: i.name,
          qty: i.qty,
          unit: i.unit || '',
          price: i.price,
          total: i.total,
          school
        });
      });

      const po = { id: Date.now(), date: new Date().toLocaleString(), school, total, items: JSON.parse(JSON.stringify(currentPO)) };
      poList.push(po);
      saveData();
      renderStock(); renderHistory(); renderPOList();
      setUnifiedReceiptPreview('po', po);
      currentPO = [];
      renderPO();
      document.getElementById('po-school').value = '';
      alert('Purchase Order saved (preview available via "Preview & Print Receipt")');
    }

    function renderPOList(){
      const tbody = document.getElementById('po-list-body');
      tbody.innerHTML = '';
      poList.forEach((po, idx)=> {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${po.date}</td><td>${escapeHtml(po.school)}</td><td>${Number(po.total).toFixed(2)}</td>
          <td>
            <button class="action-btn view-btn">View</button>
            <button class="action-btn delete-btn">Delete</button>
          </td>`;
        tr.querySelector('.view-btn').onclick = ()=> { setUnifiedReceiptPreview('po', po); document.querySelectorAll('.menu-link').forEach(l=>l.classList.remove('active')); document.querySelector('.menu-link[data-section="purchase-section"]').classList.add('active'); document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById('purchase-section').classList.add('active'); };
        tr.querySelector('.delete-btn').onclick = ()=> { if(!confirm('Delete this Purchase Order?')) return; poList.splice(idx,1); saveData(); renderPOList(); };
        tbody.appendChild(tr);
      });
    }

    /* ===========================
       Unified Receipt Builder & Previews
       =========================== */
    function buildUnifiedReceiptHTML({ type, id, customer, items, total }) {
      // Include Unit column
      const header = (type === 'po') ? 'PURCHASE ORDER' : 'SALES RECEIPT';
      const idLine = (type === 'po') ? `<div><strong>PO No:</strong> ${id}</div><div><strong>Customer:</strong> ${escapeHtml(customer || '')}</div>` : `<div><strong>Receipt No:</strong> ${id}</div><div><strong>Customer:</strong> ${escapeHtml(customer || '') || 'Walk-in'}</div>`;
      const rows = items.map(it => {
        return `<tr>
          <td style="padding:6px 4px;border-bottom:1px dashed #ccc;">${escapeHtml(it.name)}</td>
          <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:center;">${escapeHtml(it.unit || '')}</td>
          <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:center;">${Number(it.qty)}</td>
          <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:right;">${Number(it.price).toFixed(2)}</td>
          <td style="padding:6px 4px;border-bottom:1px dashed #ccc;text-align:right;">${Number(it.total).toFixed(2)}</td>
        </tr>`;
      }).join('');

      const html = `
        <div style="font-family:'Segoe UI',sans-serif;">
          <div style="text-align:center;margin-bottom:6px;">
            <h2 style="margin:0;color:var(--msite-blue);">MSITE Enterprises</h2>
            <div style="font-size:12px;margin-top:4px;">B20 L4 Cilrai, Cagayan De Oro City, Misamis Oriental</div>
            <div style="font-size:12px;margin-top:2px;">Email: msite.enterprises2016@gmail.com </div>
 		<div style="font-size:12px;margin-top:4px;">Facebook: M'site En</div>
		<div style="font-size:12px;margin-top:4px;">Contact: 09553303187</div>


          <div style="margin-top:8px;font-weight:bold;text-align:center;">${header}</div>
          <div style="margin-top:6px;font-size:13px;">${idLine}</div>
          <hr style="border:none;border-top:1px dashed #333;margin:8px 0;">

          <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr>
                <th style="text-align:left;padding:6px 4px;">Item</th>
                <th style="text-align:center;padding:6px 4px;">Unit</th>
                <th style="text-align:center;padding:6px 4px;">Qty</th>
                <th style="text-align:right;padding:6px 4px;">Price</th>
                <th style="text-align:right;padding:6px 4px;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>

          <div style="margin-top:8px;text-align:right;font-weight:bold;">
            Subtotal: ${Number(total).toFixed(2)}
          </div>

          <hr style="border:none;border-top:1px dashed #333;margin:8px 0;">
          <div style="display:flex;justify-content:space-between;margin-top:6px;">
            <div style="width:45%;text-align:center">
              <div style="border-top:1px dashed #333;height:0;margin-top:12px"></div>
              <p style="margin:6px 0 0 0;font-size:11px">Received by</p>
            </div>
            <div style="width:45%;text-align:center">
              <div style="border-top:1px dashed #333;height:0;margin-top:12px"></div>
              <p style="margin:6px 0 0 0;font-size:11px">Authorized by</p>
            </div>
          </div>

          <hr style="border:none;border-top:1px dashed #333;margin:8px 0;">
          <div style="text-align:center;font-style:italic;font-size:12px;">Thank you for purchasing at MSITE Enterprise!</div>
        </div>
      `;
      return html;
    }

    function setUnifiedReceiptPreview(type, dataObj){
      const container = (type === 'po') ? document.getElementById('receipt') : document.getElementById('cashout-receipt');
      const items = dataObj.items || [];
      const total = dataObj.total || items.reduce((s,i)=> s + Number(i.total || 0), 0);
      const id = dataObj.id || (type === 'po' ? Date.now() : ('R' + Date.now()));
      const customer = dataObj.school || dataObj.customer || '';
      container.innerHTML = buildUnifiedReceiptHTML({ type: type === 'po' ? 'po' : 'cash', id, customer, items, total });
      container.style.display = 'block';
    }

    /* preview window builder */
    function openReceiptPreviewWindow(receiptHTML, sizeKey) {
      let widthCss, fontSize, padding;
      switch (sizeKey) {
        case '80mm': widthCss = '80mm'; fontSize = '12px'; padding = '8px'; break;
        case 'A5': widthCss = '148mm'; fontSize = '13px'; padding = '12px'; break;
        case 'A4': widthCss = '210mm'; fontSize = '14px'; padding = '16px'; break;
        default: widthCss = '58mm'; fontSize = '11px'; padding = '6px';
      }

      const w = window.open('', '_blank', 'scrollbars=yes,resizable=yes');
      if (!w) { alert('Popup blocked. Allow popups to preview receipts.'); return; }

      // prepare styles and script for preview window
      const styles = `
        <style>
          body { font-family: "Segoe UI", sans-serif; margin:0; padding:${padding}; color:#000; -webkit-
-color-adjust:exact; }
          .preview-wrap { width:${widthCss}; margin:0 auto; box-sizing:border-box; }
          h2 { color:var(--msite-blue); margin:0 0 6px 0; text-align:center; }
          table { width:100%; border-collapse:collapse; margin-top:6px; font-size:${fontSize}; }
          th, td { padding:6px 4px; border-bottom:1px dashed #999; }
          th { text-align:left; }
          .btn { display:inline-block; padding:8px 12px; background:var(--msite-blue-2); color:#fff; border-radius:6px; text-decoration:none; cursor:pointer; margin:6px 4px; }
          .btn:hover { background:var(--msite-blue); }
          @media print { @page { size: ${widthCss} auto; margin: 6mm; } .no-print { display:none; } }
        </style>
      `;

      const script = `
        <script>
          function doPrint() {
            window.print();
          }
          function closeWin() { window.close(); }
          // notify opener after print completes (auto-clear action)
          window.onafterprint = function() {
            try { if(window.opener && !window.opener.closed) { window.opener.postMessage({ action: 'receiptPrinted' }, '*'); } } catch(e) {}
          };
        <\/script>
      `;

      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Receipt Preview</title>${styles}</head><body>
        <div style="text-align:right;" class="no-print">
          <button class="btn" onclick="doPrint()">Print</button>
          <button class="btn" onclick="closeWin()">Close</button>
        </div>
        <div class="preview-wrap">${receiptHTML}</div>
        ${script}
      
<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body></html>`);
      w.document.close();

      // track that preview happened (to allow auto-clear after printed)
      lastPreviewType = null; // will be set by caller
    }

    /* UI preview trigger functions */
    function previewPOReceipt(){
      const container = document.getElementById('receipt');
      if (!container.innerHTML.trim()) return alert('No Purchase Order receipt available. Save or view a PO first.');
      const sizeKey = document.getElementById('receipt-size-po').value || '58mm';
      // mark last preview type for opener to clear only if it's cash
      lastPreviewType = 'po';
      lastPreviewPayload = { type: 'po' };
      openReceiptPreviewWindow(container.innerHTML, sizeKey);
    }

    function previewCashoutReceipt(){
  const container = document.getElementById('cashout-receipt');
  if (!container.innerHTML.trim()) {
    if (cashoutBuffer.length === 0) return alert('No cashout items available. Add items before printing.');
    setUnifiedReceiptPreview('cash', { id: 'R' + Date.now(), items: JSON.parse(JSON.stringify(cashoutBuffer)), total: cashoutBuffer.reduce((s,i)=> s + Number(i.total || 0), 0) });
  }
  const sizeKey = document.getElementById('receipt-size-cash').value || '58mm';
  const html = document.getElementById('cashout-receipt').innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print</title></head><body>${html}
<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.close();
  // optional: clear after print
  cashoutBuffer = [];
  saveData();
  renderCashoutTable();
  renderStock();
}


    /* Listen for print-complete messages from preview window */
    window.addEventListener('message', (ev) => {
      try {
        const data = ev.data || {};
        if (data.action === 'receiptPrinted') {
          // if last preview was cash, clear the buffer (auto-clear after successful print)
          if (lastPreviewType === 'cash') {
            cashoutBuffer = [];
            saveData();
            renderCashoutTable();
            renderStock();
            alert('Cashout printed  cart cleared.');
          } else {
            // PO printing doesn't clear cart
            alert('Receipt printed.');
          }
        }
      } catch(e) { /* ignore */ }
    });

    /* ===========================
       Cashout functions
       =========================== */
    function addToCashout(){
      const name = document.getElementById('cashout-item').value.trim();
      const qty = parseFloat(document.getElementById('cashout-qty').value);
      if(!name || isNaN(qty) || qty<=0) return alert('Enter valid item and quantity');
      const stock = stockData.find(s => s.name.toLowerCase() === name.toLowerCase());
      if(!stock) return alert('Item not found in stock');
      if(stock.qty < qty) return alert('Not enough stock available');
      const price = Number(stock.price) || 0;
      const record = { name: stock.name, qty, unit: stock.unit || '', price, total: qty*price };
      cashoutBuffer.push(record);
      stock.qty -= qty;
      saveData();
      renderStock(); renderCashoutTable();
      document.getElementById('cashout-item').value = '';
      document.getElementById('cashout-qty').value = '';
    }

    function renderCashoutTable(){
      const tbody = document.getElementById('salesTableBody');
      tbody.innerHTML = ''; let sum=0;
      cashoutBuffer.forEach((r, idx) => {
        sum += r.total;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.name)}</td>
                        <td contenteditable="true">${r.qty}</td>
                        <td contenteditable="true">${escapeHtml(r.unit || '')}</td>
                        <td contenteditable="true">${Number(r.price).toFixed(2)}</td>
                        <td>${Number(r.total).toFixed(2)}</td>
                        <td><button class="action-btn delete-btn">Remove</button></td>`;
        tr.querySelector('button').onclick = () => {
          const stockItem = stockData.find(s => s.name === r.name);
          if (stockItem) stockItem.qty += r.qty;
          cashoutBuffer.splice(idx,1);
          saveData();
          renderStock();
          renderCashoutTable();
        };

        // inline edit handlers
        const tdQty = tr.children[1];
        const tdUnit = tr.children[2];
        const tdPrice = tr.children[3];
        tdQty.addEventListener('blur', ()=>{ const v=parseFloat(tdQty.textContent); if(isNaN(v)|| v<=0){ renderCashoutTable(); return; } r.qty = v; r.total = r.qty * r.price; saveData(); renderCashoutTable(); });
        tdUnit.addEventListener('blur', ()=>{ r.unit = tdUnit.textContent.trim(); saveData(); renderCashoutTable(); });
        tdPrice.addEventListener('blur', ()=>{ const v=parseFloat(tdPrice.textContent); if(isNaN(v)|| v<0){ renderCashoutTable(); return; } r.price = v; r.total = r.qty * r.price; saveData(); renderCashoutTable(); });

        tbody.appendChild(tr);
      });
      document.getElementById('salesTotal').textContent = sum.toFixed(2);
    }

    function finalizeCashout(){
      if(cashoutBuffer.length===0) return alert('No items to finalize');
      const date = new Date().toLocaleString();
      let grand = 0;
      const idBase = Date.now();
      cashoutBuffer.forEach((r, idx) => {
        const entryId = idBase + idx;
        salesData.push({ id: entryId, date, name: r.name, qty: r.qty, unit: r.unit || '', price: r.price, total: r.total, school: 'Walk-in' });
        grand += r.total;
      });
      saveData();
      // create preview in-app
      setUnifiedReceiptPreview('cash', { id: 'R' + Date.now(), items: JSON.parse(JSON.stringify(cashoutBuffer)), total: grand });
      // Promise: do NOT clear right away  only after print
      // show toast
      alert('Cashout saved to Sales History (preview available via "Preview & Print Receipt").');
      renderHistory();
    }

    /* ===========================
       Receipt preview actions from modal (in-page)
       =========================== */
    function openModalPreview(htmlContent) {
      document.getElementById('preview-content').innerHTML = htmlContent;
      document.getElementById('preview-modal').classList.add('show');
    }
    function closeModalPreview() {
      document.getElementById('preview-modal').classList.remove('show');
      document.getElementById('preview-content').innerHTML = '';
    }
    function openPrintWindowFromModal(){
      const content = document.getElementById('preview-content').innerHTML;
      if(!content.trim()) return alert('No content');
      // choose size from cash or po dropdown - default to 58mm
      const sizeKey = document.getElementById('receipt-size-cash').value || document.getElementById('receipt-size-po')?.value || '58mm';
      openReceiptPreviewWindow(content, sizeKey);
      closeModalPreview();
    }

    /* Preview triggers used by UI (fallback: in-page modal) */
   function previewPOReceipt(){
  const container = document.getElementById('receipt');
  if (!container.innerHTML.trim()) return alert('No Purchase Order receipt available. Save or view a PO first.');
  const sizeKey = document.getElementById('receipt-size-po').value || '58mm';
  const html = container.innerHTML;
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>Print</title></head><body>${html}
<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}


    function previewCashoutReceipt(){
      const container = document.getElementById('cashout-receipt');
      if (!container.innerHTML.trim()) {
        if (cashoutBuffer.length === 0) return alert('No cashout items available. Add items before previewing.');
        setUnifiedReceiptPreview('cash', { id: 'R' + Date.now(), items: JSON.parse(JSON.stringify(cashoutBuffer)), total: cashoutBuffer.reduce((s,i)=> s + Number(i.total || 0), 0) });
      }
      const sizeKey = document.getElementById('receipt-size-cash').value || '58mm';
      lastPreviewType = 'cash';
      lastPreviewPayload = { type: 'cash' };
      openReceiptPreviewWindow(document.getElementById('cashout-receipt').innerHTML, sizeKey);
    }

    /* ===========================
       Sales history
       =========================== */
    function renderHistory(){
      const tbody = document.getElementById('history-table-body');
      tbody.innerHTML = '';
      salesData.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.date}</td><td>${escapeHtml(s.name)}</td><td>${s.qty}</td><td>${escapeHtml(s.unit || '')}</td><td>${Number(s.price).toFixed(2)}</td><td>${Number(s.total).toFixed(2)}</td><td>${escapeHtml(s.school || '')}</td>`;
        tbody.appendChild(tr);
      });
    }

    function clearSalesHistory(){
      if(!confirm('Clear history?')) return;
      salesData = [];
      saveData();
      renderHistory();
    }

    /* ===========================
       Initialization & navigation
       =========================== */
    if(!localStorage.getItem('stockData')){
      stockData = [
        { name: 'Notebook A4', qty: 100, price: 30, unit: 'pcs' },
        { name: 'Bond Paper A4', qty: 50, price: 200, unit: 'reams' }
      ];
      saveData();
    } else {
      stockData = JSON.parse(localStorage.getItem('stockData')) || [];
    }
    salesData = JSON.parse(localStorage.getItem('salesData')) || [];
    poList = JSON.parse(localStorage.getItem('poList')) || [];

    document.querySelectorAll('.menu-link').forEach(link=>{
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        document.querySelectorAll('.menu-link').forEach(l=>l.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        link.classList.add('active');
        const sec = document.getElementById(link.dataset.section);
        if(sec) sec.classList.add('active');
      });
    });

    // start
    renderStock();
    updateItemLists();
    renderPO();
    renderCashoutTable();
    renderHistory();
    renderPOList();

    /* ===========================
       Message: print complete handling for auto-clear
       =========================== */
    // Already handled in window message listener above.

    // (No more code below)
function printStockTable() {
  const table = document.getElementById('stockTable');
  if (!table || table.rows.length === 0) return alert('No stock data to print.');

  // Clone table (to remove action buttons)
  const clonedTable = table.cloneNode(true);
  Array.from(clonedTable.querySelectorAll('th:last-child, td:last-child')).forEach(el => el.remove());

  const printWindow = window.open('', '', 'height=800,width=1000');
  printWindow.document.write(`
    <html>
      <head>
        <title>Stock List - MSITE Enterprises</title>
        <style>
          body {
            font-family: "Segoe UI", sans-serif;
            background: #fff;
            margin: 20px;
            color: #333;
          }
          h2 {
            text-align: center;
            color: #0a3d62;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }
          th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
          }
          th {
            background-color: #0a3d62;
            color: white;
          }
          tr:nth-child(even) {
            background-color: #f9fbff;
          }
          tr:hover {
            background-color: #e8f0ff;
          }
          @media print {
            body { margin: 10mm; }
          }
        </style>
      </head>
      <body>
        <h2>MSITE Enterprises</h2>
        <h3 style="text-align:center;margin:0;">Current Stock List</h3>
        ${clonedTable.outerHTML}
        <div style="text-align:right;margin-top:20px;font-weight:bold;">
          Printed on: ${new Date().toLocaleString()}
        </div>
      
<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}
// Collapsible sidebar toggle
document.getElementById("toggleSidebar").addEventListener("click", () => {
  const sidebar = document.querySelector(".sidebar");
  const content = document.querySelector(".content");
  sidebar.classList.toggle("collapsed");
  content.classList.toggle("sidebar-collapsed");
});
// Register service worker for PWA
//SW_REG_START
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registered'))
    .catch(err => console.error('Service Worker registration failed:', err));
}



  </script>
//SW_REG_START
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker ready'))
    .catch(err => console.error('SW failed:', err));
}


<!-- FIREBASE + SYNC LOGIC (injected by ChatGPT) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
<script>
  // Firebase config (from user)
  const firebaseConfig = {"apiKey": "AIzaSyAxxxxx...", "authDomain": "msite-inventory.firebaseapp.com", "projectId": "msite-inventory", "storageBucket": "msite-inventory.appspot.com", "messagingSenderId": "1234567890", "appId": "1:1234567890:web:abcdef123456"};
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // STOCK SYNC: keep localStorage as source of truth for offline, but upload local items if cloud empty.
  let localStock = JSON.parse(localStorage.getItem('stockData') || '[]');
  const stockCol = db.collection('stock');

  // Utility: save local
  function saveLocal(){ localStorage.setItem('stockData', JSON.stringify(localStock)); }

  // Upload local items that lack cloud ids
  async function uploadLocalPending(){
    if(!navigator.onLine) return;
    try{
      const snapshot = await stockCol.get();
      // If cloud empty and local has items, upload them
      if(snapshot.empty && localStock.length>0){
        for(const item of localStock){
          try{
            const docRef = await stockCol.add(item);
            // store cloud id locally (best-effort match by name+qty)
            item.id = docRef.id;
          }catch(e){ console.warn('uploadLocalPending add failed', e); }
        }
        saveLocal();
      }
    }catch(e){
      console.warn('uploadLocalPending failed', e);
    }
  }

  // Listen to cloud changes and merge (cloud wins for simplicity)
  function startCloudListener(){
    try{
      stockCol.onSnapshot(snapshot=>{
        const cloudItems = [];
        snapshot.forEach(doc=> cloudItems.push(Object.assign({id:doc.id}, doc.data())));
        if(cloudItems.length>0){
          // merge: prefer cloud, but keep local-only items appended
          const localOnly = localStock.filter(function(ls){ return !cloudItems.some(function(ci){ return ci.name===ls.name && ci.qty===ls.qty; }); });
          localStock = cloudItems.concat(localOnly);
          saveLocal();
          if(typeof renderStock === 'function') renderStock();
          if(typeof updateItemLists === 'function') updateItemLists();
        } else {
          if(typeof renderStock === 'function') renderStock();
        }
      }, err=> console.warn('onSnapshot error', err));
    }catch(e){
      console.warn('startCloudListener failed (probably offline)', e);
    }
  }

  // When back online, upload any local items missing an id
  window.addEventListener('online', async function(){
    console.info('Back online — attempting to sync local stock to Firestore...');
    try{
      var local = JSON.parse(localStorage.getItem('stockData')||'[]');
      for(var i=0;i<local.length;i++){
        var item = local[i];
        if(!item.id){
          try{
            var docRef = await stockCol.add({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 });
            item.id = docRef.id;
          }catch(e){ console.warn('add failed', e); }
        } else {
          try{ await stockCol.doc(item.id).set({ name:item.name, qty:item.qty, unit:item.unit||'', price:item.price||0 }); }catch(e){}
        }
      }
      localStorage.setItem('stockData', JSON.stringify(local));
    }catch(e){ console.warn('Error syncing on online', e); }
    startCloudListener();
  });

  (function initSync(){
    try{
      if(navigator.onLine){
        uploadLocalPending().then(function(){ startCloudListener(); });
      } else {
        console.info('Offline at init — using local data for now');
      }
    }catch(e){ console.warn('initSync err', e); }
  })();
</script>
<!-- END FIREBASE INJECTION -->

</body>
</html>
